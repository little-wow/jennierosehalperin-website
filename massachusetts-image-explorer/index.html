<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Massachusetts Image Explorer</title>
  <meta name="description" content="Search Massachusetts-focused images from Wikimedia Commons, Digital Commonwealth, Internet Archive, and Openverse." />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style>
    body {
      background: linear-gradient(180deg, #f7f9ff 0%, #f3f7ff 45%, #eef3ff 100%);
      min-height: 100vh;
    }
    .hero-card {
      background: rgba(255,255,255,0.92);
      border: 1px solid #dbe5ff;
      box-shadow: 0 20px 50px rgba(31, 60, 136, 0.10);
      backdrop-filter: blur(6px);
    }
    .source-box {
      background: #f8fbff;
      border: 1px solid #d9e6ff;
      border-radius: .75rem;
      padding: .75rem;
    }
    .result-card {
      border: 1px solid #dee6fa;
      box-shadow: 0 10px 24px rgba(34, 63, 145, 0.08);
      transition: transform .15s ease, box-shadow .15s ease;
      height: 100%;
    }
    .result-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 30px rgba(34, 63, 145, 0.14);
    }
    .result-image {
      width: 100%;
      height: 220px;
      object-fit: cover;
      background: #edf3ff;
    }
    .source-badge {
      font-size: .72rem;
      letter-spacing: .02em;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="#">Massachusetts Image Explorer</a>
    </div>
  </nav>

  <main class="container py-4 py-md-5">
    <section class="card hero-card rounded-4 mb-4">
      <div class="card-body p-4 p-md-5">
        <div class="d-flex flex-column flex-md-row gap-3 justify-content-between align-items-md-center mb-3">
          <div>
            <h1 class="h2 mb-2">Explore Massachusetts-focused image archives</h1>
            <p class="text-secondary mb-0">Search across Wikimedia Commons, Digital Commonwealth, Internet Archive, and Creative Commons Search (Openverse).</p>
          </div>
          <span class="badge text-bg-primary rounded-pill px-3 py-2">Open archives</span>
        </div>

        <form id="search-form" aria-label="Search archives" class="row g-3">
          <div class="col-12 col-lg-9">
            <label for="query" class="form-label fw-semibold">Refine topic inside Massachusetts</label>
            <input id="query" name="query" type="text" class="form-control form-control-lg" value="history" placeholder="e.g., Cape Cod, abolition, Worcester" />
          </div>
          <div class="col-12 col-lg-3 d-flex align-items-end">
            <button type="submit" class="btn btn-primary btn-lg w-100">Find images</button>
          </div>

          <div class="col-12">
            <fieldset class="source-box">
              <legend class="fs-6 fw-semibold mb-2">Choose sources</legend>
              <div class="row g-2">
                <label class="col-12 col-md-6 col-lg-3 form-check px-4"><input class="form-check-input me-2" type="checkbox" name="sources" value="wikimedia" checked> Wikimedia Commons</label>
                <label class="col-12 col-md-6 col-lg-3 form-check px-4"><input class="form-check-input me-2" type="checkbox" name="sources" value="digital" checked> Digital Commonwealth</label>
                <label class="col-12 col-md-6 col-lg-3 form-check px-4"><input class="form-check-input me-2" type="checkbox" name="sources" value="archive" checked> Internet Archive</label>
                <label class="col-12 col-md-6 col-lg-3 form-check px-4"><input class="form-check-input me-2" type="checkbox" name="sources" value="openverse" checked> Openverse</label>
              </div>
            </fieldset>
          </div>
        </form>

        <p class="text-secondary small mt-3 mb-0">Each request automatically includes “Massachusetts,” with extra relevance filtering after results load.</p>
      </div>
    </section>

    <div class="d-flex align-items-center gap-2 mb-3">
      <div class="spinner-border spinner-border-sm text-primary d-none" role="status" id="loading-spinner"><span class="visually-hidden">Loading...</span></div>
      <p id="status" class="text-secondary mb-0" aria-live="polite"></p>
    </div>

    <section id="warnings" class="mb-3"></section>
    <section id="results" class="row g-3" aria-live="polite"></section>
  </main>

<script>
const statusEl = document.getElementById('status');
const warnEl = document.getElementById('warnings');
const resultsEl = document.getElementById('results');
const form = document.getElementById('search-form');
const spinner = document.getElementById('loading-spinner');
const SOURCE_LIMIT = 10;

const IS_HTTP_CONTEXT = /^https?:$/.test(window.location.protocol);
const PROXY_BASE = window.MA_PROXY_BASE || (IS_HTTP_CONTEXT ? `${window.location.origin}/api/search` : '');
let currentSearchTerm = 'history';

async function fetchSourceJson(source, directUrl) {
  let proxyDiagnostic = null;

  if (PROXY_BASE) {
    const proxyUrl = `${PROXY_BASE}?source=${encodeURIComponent(source)}&query=${encodeURIComponent(currentSearchTerm)}&limit=${SOURCE_LIMIT}`;
    try {
      const proxyRes = await fetch(proxyUrl);
      if (proxyRes.ok) return await proxyRes.json();

      let payload = null;
      try { payload = await proxyRes.json(); } catch (_) {}
      proxyDiagnostic = payload;
    } catch (error) {
      proxyDiagnostic = { detail: error?.message || 'proxy request failed' };
    }
  }

  try {
    return await (await fetch(directUrl)).json();
  } catch (directError) {
    const proxyHint = proxyDiagnostic
      ? ` | proxy diagnostic: ${proxyDiagnostic.category || 'unknown'} (${proxyDiagnostic.code || 'n/a'}) ${proxyDiagnostic.detail || proxyDiagnostic.hint || ''}`
      : '';
    throw new Error(`${directError.message}${proxyHint}`.trim());
  }
}

const SOURCE_MAP = {
  wikimedia: ['Wikimedia Commons', fromWikimedia],
  digital: ['Massachusetts Digital Commonwealth', fromDigitalCommonwealth],
  archive: ['Internet Archive', fromInternetArchive],
  openverse: ['Creative Commons Search (Openverse)', fromOpenverse],
};

const includesMassachusetts = (s='') => /\bmassachusetts\b/i.test(String(s));

function normalize(item) {
  const safe = v => v == null ? '' : String(v);
  const title = safe(item.title).trim() || 'Untitled image';
  return {
    source: safe(item.source),
    title,
    image: safe(item.image),
    page: safe(item.page),
    creator: safe(item.creator),
    license: safe(item.license),
    blob: `${title} ${safe(item.description)} ${safe(item.subjects)}`,
  };
}

async function fromWikimedia(q) {
  const u = new URL('https://commons.wikimedia.org/w/api.php');
  u.search = new URLSearchParams({
    action: 'query', format: 'json', origin: '*', generator: 'search',
    gsrsearch: `filetype:bitmap Massachusetts ${q}`,
    gsrnamespace: '6', gsrlimit: String(SOURCE_LIMIT),
    prop: 'imageinfo', iiprop: 'url|user|extmetadata'
  });
  const data = await fetchSourceJson('wikimedia', u);
  const pages = Object.values(data.query?.pages || {});
  return pages.map((p) => {
    const info = p.imageinfo?.[0] || {};
    return normalize({
      source: 'Wikimedia Commons',
      title: p.title?.replace(/^File:/, ''),
      image: info.thumburl || info.url,
      page: info.descriptionurl,
      creator: info.user,
      license: info.extmetadata?.LicenseShortName?.value,
      description: info.extmetadata?.ImageDescription?.value,
    });
  }).filter(i => i.image && includesMassachusetts(i.blob));
}

async function fromDigitalCommonwealth(q) {
  const u = new URL('https://www.digitalcommonwealth.org/search.json');
  u.search = new URLSearchParams({
    q: `Massachusetts ${q}`,
    per_page: String(SOURCE_LIMIT),
    search_field: 'all_fields',
    'f[human_readable_type_ssim][]': 'Still Image'
  });
  const data = await fetchSourceJson('digital', u);
  const docs = data.response?.docs || [];
  return docs.map((d) => {
    const id = d.id;
    return normalize({
      source: 'Massachusetts Digital Commonwealth',
      title: d.title_info_primary_tsi,
      image: `https://iiif.digitalcommonwealth.org/iiif/2/${id}%2Ffull%2F!600,600%2F0/default.jpg`,
      page: `https://www.digitalcommonwealth.org/search/${id}`,
      creator: (d.name_tsim || [])[0],
      license: (d.rights_tsim || [])[0],
      description: (d.abstract_tsim || []).join(' '),
      subjects: (d.subject_topic_tsim || []).join(' '),
    });
  }).filter(i => i.image && includesMassachusetts(i.blob));
}

async function fromInternetArchive(q) {
  const u = new URL('https://archive.org/advancedsearch.php');
  u.search = new URLSearchParams({
    q: `(mediatype:image) AND (title:(Massachusetts ${q}) OR subject:(Massachusetts ${q}))`,
    fl: 'identifier,title,creator,subject', rows: String(SOURCE_LIMIT), page: '1', output: 'json'
  });
  const data = await fetchSourceJson('archive', u);
  const docs = data.response?.docs || [];
  return docs.map((d) => normalize({
    source: 'Internet Archive',
    title: d.title,
    image: `https://archive.org/services/img/${d.identifier}`,
    page: `https://archive.org/details/${d.identifier}`,
    creator: d.creator,
    license: 'Varies by item',
    subjects: Array.isArray(d.subject) ? d.subject.join(' ') : d.subject
  })).filter(i => i.image && includesMassachusetts(i.blob));
}

async function fromOpenverse(q) {
  const u = new URL('https://api.openverse.engineering/v1/images/');
  u.search = new URLSearchParams({ q: `Massachusetts ${q}`, page_size: String(SOURCE_LIMIT), license_type: 'all' });
  const data = await fetchSourceJson('openverse', u);
  return (data.results || []).map((r) => normalize({
    source: 'Creative Commons Search (Openverse)',
    title: r.title,
    image: r.thumbnail || r.url,
    page: r.foreign_landing_url || r.url,
    creator: r.creator,
    license: r.license,
    description: (r.tags || []).map(t => t.name).join(' ')
  })).filter(i => i.image && includesMassachusetts(i.blob));
}

function render(items, warnings) {
  warnEl.innerHTML = '';
  resultsEl.innerHTML = '';

  warnings.forEach((w) => {
    const alert = document.createElement('div');
    alert.className = 'alert alert-warning shadow-sm';
    alert.textContent = w;
    warnEl.appendChild(alert);
  });

  if (!items.length) {
    resultsEl.innerHTML = '<div class="col-12"><div class="alert alert-light border">No matching Massachusetts images were returned. Try another topic or choose different sources.</div></div>';
    return;
  }

  for (const i of items) {
    const col = document.createElement('div');
    col.className = 'col-12 col-md-6 col-xl-4';
    col.innerHTML = `
      <article class="card result-card rounded-4 overflow-hidden">
        <img src="${i.image}" alt="Preview for ${i.title}" class="result-image" loading="lazy" />
        <div class="card-body">
          <span class="badge text-bg-primary source-badge mb-2">${i.source}</span>
          <h2 class="h6 mb-2">${i.title}</h2>
          <p class="small text-secondary mb-1"><strong>Creator:</strong> ${i.creator || 'Unknown'}</p>
          <p class="small text-secondary mb-2"><strong>License:</strong> ${i.license || 'Not specified'}</p>
          <a class="btn btn-outline-primary btn-sm" href="${i.page}" target="_blank" rel="noopener noreferrer">Open original ↗</a>
        </div>
      </article>`;
    resultsEl.appendChild(col);
  }
}

function selectedSources() {
  const values = Array.from(form.querySelectorAll('input[name="sources"]:checked')).map((el) => el.value);
  return values.length ? values : ['wikimedia', 'digital', 'archive'];
}

async function search(term='history') {
  const query = (term || '').trim() || 'history';
  currentSearchTerm = query;
  const activeSourceKeys = selectedSources();
  const sources = activeSourceKeys.map((key) => SOURCE_MAP[key]).filter(Boolean);

  spinner.classList.remove('d-none');
  statusEl.textContent = `Searching for Massachusetts + "${query}" in ${sources.length} selected source${sources.length === 1 ? '' : 's'}...`;

  const warnings = [];
  const batches = await Promise.all(sources.map(async ([name, fn]) => {
    try {
      return await fn(query);
    } catch (e) {
      warnings.push(`${name} could not be loaded in this browser session (${e.message}).`);
      return [];
    }
  }));

  const items = batches.flat();
  statusEl.textContent = `Showing ${items.length} Massachusetts image result${items.length === 1 ? '' : 's'}.`;
  spinner.classList.add('d-none');
  render(items, warnings);
}

form.addEventListener('submit', (e) => {
  e.preventDefault();
  const val = new FormData(form).get('query');
  search(val);
});

search();
</script>
</body>
</html>
